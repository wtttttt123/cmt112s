<!DOCTYPE html>
<html>
<head>
	<title>spotify</title>
</head>
<body>

	<h1>the singer's popular songs</h1>
	<a href=index.html>back</a>
    <div>
    <form>
        <label for="event_search">singer:
            <input type="text" name="search" id="ree">
        </label>
        <input type="button" id="singer_button" value="search">
    </form>
    </div>
	<div id="simg">
		<img src="" alt="songer" id="artistimg">
	</div>
	<div id="output">
		<ol>
			
		</ol>
	</div>
	<button type="button" id='addlist'>Add Playlist!</button>
	<script>
		var user_id;
		var listname='newwwwww list';
		var popid=[];
		var qq="rihanna";

		// var research=document.getElementById("ree").value;
		// console.log(research)
		// if (research==undefined){
		// 	qq = "rihanna";
		// };


		var searchbutton=document.getElementById("singer_button")
		searchbutton.addEventListener("click",function(){
			qq=document.getElementById("ree").value;
			var cc=document.getElementsByTagName("li");
    		Element.prototype.remove = function() {
    		this.parentElement.removeChild(this);
    		}
    		NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        	for(var i = this.length - 1; i >= 0; i--) {
            if(this[i] && this[i].parentElement) {
                this[i].parentElement.removeChild(this[i]);
		            }
		        }
		    }
		    cc.remove();
		   	popid.length=0;
			getSinger();

		});



		var setimg=function(imgurl){
			var imgg=document.querySelector("#artistimg");
			imgg.src=imgurl;
		};


		var addTracks=function(user_id,playlist_id){
			var add_tracks_url='https://api.spotify.com/v1/users/'+user_id+'/playlists/'+playlist_id+'/tracks';
			var xhttp=new XMLHttpRequest();
			xhttp.open('POST',add_tracks_url);
			xhttp.setRequestHeader('Authorization','Bearer '+access_token);
			xhttp.setRequestHeader('Content-Type','application/json');
			xhttp.addEventListener('load', function(){
				console.log(this.response);	
			});
			var params={
				uris:popid              
			};
			xhttp.send(JSON.stringify(params));
		}
		var createPlayList=function(user_id){
			var create_player_url='https://api.spotify.com/v1/users/'+user_id+'/playlists';
			var xhttp=new XMLHttpRequest();
			xhttp.open('POST',create_player_url);
			xhttp.setRequestHeader('Authorization','Bearer '+access_token);
			xhttp.setRequestHeader('Content-Type','application/json');
			xhttp.addEventListener('load', function(){
				console.log(this.response);
				var response=JSON.parse(this.response);
				var playlist_id=response.id;
				addTracks(user_id,playlist_id);
			});
			var params={
				name:listname,
				public:true,
				description:'aaa'
			};	
    		xhttp.send(JSON.stringify(params));
    		
		};

		var encodeParameters = function(params) {
		    // join all key value pairs and store in an array
		    var strArray = [];
		    for (var key in params) {
		        if (params.hasOwnProperty(key)) {
		            var paramString = key + "=" + params[key];
		            strArray.push(paramString);
		        }
		    }
		    // join everything in the array together
		    return strArray.join("&");
		}

		console.log(window.location.hash);

		var extract=function(){
			var query=window.location.hash.substring(1);
			var params=query.split("&");
			var return_data={};
			for (var i=0;i<params.length;i++){
				var keyvalue=params[i].split('=');
				console.log(keyvalue);
				return_data[keyvalue[0]]=keyvalue[1]
			}
			return return_data;
		}

		var processResponce=function(items){
    		var list=document.querySelector("#output ol");
    		for (let i=0;i<items.length;i++){
        		var list_item=document.createElement('li');
        		var text_item=document.createTextNode(items[i].name+'---'+'<'+items[i].album.name+'>---'+items[i].artists[0].name);

        		popid.push('spotify:track:'+items[i].id)
        		// list_item.addEventListener('mouseenter',function(){
        		// 	var popularity=items[i].track.popularity;
        		// 	var pop_span=document.querySelector('#pop-number');
        		// 	pop_span.innerHTML=popularity;
        		// });
        		// list_item.addEventListener('mouseleave',function(){
        		// 	var popularity=items[i].track.popularity;
        		// 	var pop_span=document.querySelector('#pop-number');
        		// 	pop_span.innerHTML=null;
        		// });
        		list_item.appendChild(text_item);
        		list.appendChild(list_item);
        	
		    }
		};

		var processResponce1=function(items){
    		var list=document.querySelector("#output ol");
    		for (let i=0;i<items.items.length;i++){
        		var list_item=document.createElement('li');
        		var text_item=document.createTextNode(items.items[i].name+'---');
        		list_item.addEventListener('mouseenter',function(){
        			var popularity=items[i].track.popularity;
        			var pop_span=document.querySelector('#pop-number');
        			pop_span.innerHTML=popularity;
        		});
        		list_item.addEventListener('mouseleave',function(){
        			var popularity=items[i].track.popularity;
        			var pop_span=document.querySelector('#pop-number');
        			pop_span.innerHTML=null;
        		});
        		list_item.appendChild(text_item);
        		list.appendChild(list_item);
		    }
		};


		var parameters=extract();

		var access_token=parameters['access_token'];		
		console.log(access_token)
		// var recently_played_url='https://api.spotify.com/v1/me/player/recently-played'
		// var params={
		// 	limit:20
		// }
		// var query_url=recently_played_url+'?'+encodeParameters(params);
		// var xhttp = new XMLHttpRequest();
  //   	console.log(query_url);
  //   	xhttp.open('GET', query_url);
  //   	xhttp.setRequestHeader('Authorization','Bearer '+access_token);
  //   	xhttp.send();
  //   	xhttp.addEventListener('load', function(){
  //   		var response=JSON.parse(this.response)
  //   		console.log(response)
  //   		processResponce(response.items)
  //   	});
    	
    	var getSong=function(id){
    		var song_url="https://api.spotify.com/v1/artists/"+id+"/top-tracks?country=GB"
    		var xhttp = new XMLHttpRequest();
	    	xhttp.open('GET', song_url);
	    	xhttp.setRequestHeader('Authorization','Bearer '+access_token);
	    	xhttp.send();
	    	xhttp.addEventListener('load', function(){
	    		var response=JSON.parse(this.response);
	    		console.log(response);
	    		processResponce(response.tracks);

	    	});
    	};

    	var add_list=document.querySelector("#addlist");
	    add_list.addEventListener('click', function(){
	    	var me_url="https://api.spotify.com/v1/me";
    		var xhttp = new XMLHttpRequest();
			xhttp.open('GET', me_url);
			xhttp.setRequestHeader('Authorization','Bearer '+access_token);
			xhttp.send();
			xhttp.addEventListener('load', function(){
			var response=JSON.parse(this.response);
			user_id=response.id;
			createPlayList(user_id);
			alert("successful");
			});
		});


    	var getSinger=function() {
    		var artp={
			q: qq,
			type: "artist"
			}
			var search_art_url='https://api.spotify.com/v1/search'
			var search_art=search_art_url+'?'+encodeParameters(artp);

	    	var xhttp = new XMLHttpRequest();
	    	xhttp.open('GET', search_art);
	    	xhttp.setRequestHeader('Authorization','Bearer '+access_token);
	    	xhttp.send();
	    	xhttp.addEventListener('load', function(){
	    		var response=JSON.parse(this.response);
	    		console.log(response);
	    		var singer_id=response.artists.items[0].id;
	    		var simg=response.artists.items[0].images[0].url;
	    		console.log(response.artists.items[0].id);
	    		getSong(singer_id);
	    		setimg(simg);
	    	});
	    }
  
   		getSinger();

	</script>

</body>
</html>